# ============================================================================
# –ú–ò–ì–†–ê–¶–ò–ò –ë–ê–ó–´ –î–ê–ù–ù–´–• (–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è Windows/PowerShell)
# ============================================================================

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è Windows)
ifneq (,$(wildcard ./.env))
    include .env
    export
endif

# –ü—É—Ç–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
MIGRATIONS_PATH = ./migrations
MIGRATE = migrate
DB_URL = postgres://$(DB_USER):$(DB_PASSWORD)@$(DB_HOST):$(DB_PORT)/$(DB_NAME)?sslmode=$(DB_SSLMODE)

.PHONY: migrate-create migrate-up migrate-down migrate-force migrate-version migrate-test migrate-check migrate-help migrate-down-all migrate-up-steps migrate-down-steps migrate-create-idempotent

# ============================================================================
# –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´
# ============================================================================

## –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make migrate-create name=<–Ω–∞–∑–≤–∞–Ω–∏–µ_–º–∏–≥—Ä–∞—Ü–∏–∏>
migrate-create:
	@if not defined name ( \
		echo ‚ùå –û—à–∏–±–∫–∞: —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ & \
		echo    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make migrate-create name=^<–Ω–∞–∑–≤–∞–Ω–∏–µ^> & \
		exit /b 1 \
	)
	@echo üîß –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏: $(name)
	@$(MIGRATE) create -ext sql -dir $(MIGRATIONS_PATH) -seq $(name)
	@echo ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –≤ –ø–∞–ø–∫–µ $(MIGRATIONS_PATH)
	@echo üìù –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ SQL —Ñ–∞–π–ª—ã!

## –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–≤–ø–µ—Ä–µ–¥)
migrate-up:
	@echo üîº –ù–∞–∫–∞—Ç—ã–≤–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏...
	@$(MIGRATE) -path $(MIGRATIONS_PATH) -database "$(DB_URL)" up
	@echo ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

## –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é (–Ω–∞–∑–∞–¥)
migrate-down:
	@echo üîΩ –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é...
	@$(MIGRATE) -path $(MIGRATIONS_PATH) -database "$(DB_URL)" down
	@echo ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–∫–∞—á–µ–Ω–∞

## –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é
## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make migrate-force version=<–Ω–æ–º–µ—Ä_–≤–µ—Ä—Å–∏–∏>
migrate-force:
	@if not defined version ( \
		echo ‚ùå –û—à–∏–±–∫–∞: —É–∫–∞–∂–∏—Ç–µ –≤–µ—Ä—Å–∏—é & \
		echo    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make migrate-force version=^<–Ω–æ–º–µ—Ä^> & \
		echo    –ü—Ä–∏–º–µ—Ä: make migrate-force version=1 & \
		exit /b 1 \
	)
	@echo ‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ—Ä—Å–∏–∏ $(version)
	@echo    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É —Ç–æ–ª—å–∫–æ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è 'dirty' —Å–æ—Å—Ç–æ—è–Ω–∏—è!
	@$(MIGRATE) -path $(MIGRATIONS_PATH) -database "$(DB_URL)" force $(version)
	@echo ‚úÖ –í–µ—Ä—Å–∏—è $(version) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞

## –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –º–∏–≥—Ä–∞—Ü–∏–π
migrate-version:
	@$(MIGRATE) -path $(MIGRATIONS_PATH) -database "$(DB_URL)" version

# ============================================================================
# –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ò –ü–†–û–í–ï–†–ö–ò (–£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –¥–ª—è Windows)
# ============================================================================

## –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (up -> down -> up)
migrate-test:
	@echo üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏...
	@echo 1. –ù–∞–∫–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏...
	@$(MIGRATE) -path $(MIGRATIONS_PATH) -database "$(DB_URL)" up || echo –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ç–µ—Å—Ç...
	@echo 2. –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏...
	@$(MIGRATE) -path $(MIGRATIONS_PATH) -database "$(DB_URL)" down -all || echo –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ç–µ—Å—Ç...
	@echo 3. –°–Ω–æ–≤–∞ –Ω–∞–∫–∞—Ç—ã–≤–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏...
	@$(MIGRATE) -path $(MIGRATIONS_PATH) -database "$(DB_URL)" up || echo –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ç–µ—Å—Ç...
	@echo ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ú–∏–≥—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã (–±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
migrate-check:
	@echo üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã...
	@echo ‚úÖ –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ (–¥–µ—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—Ä–µ–±—É—é—Ç Unix-–æ–∫—Ä—É–∂–µ–Ω–∏—è)

# ============================================================================
# –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ö–û–ú–ê–ù–î–´
# ============================================================================

## –û—Ç–∫–∞—Ç–∏—Ç—å –í–°–ï –º–∏–≥—Ä–∞—Ü–∏–∏
migrate-down-all:
	@echo üîÑ –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –í–°–ï –º–∏–≥—Ä–∞—Ü–∏–∏...
	@$(MIGRATE) -path $(MIGRATIONS_PATH) -database "$(DB_URL)" down -all
	@echo ‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –æ—Ç–∫–∞—á–µ–Ω—ã

## –ü—Ä–∏–º–µ–Ω–∏—Ç—å N –º–∏–≥—Ä–∞—Ü–∏–π
## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make migrate-up-steps steps=<–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ>
migrate-up-steps:
	@if not defined steps ( \
		echo ‚ùå –û—à–∏–±–∫–∞: —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤ & \
		echo    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make migrate-up-steps steps=^<—á–∏—Å–ª–æ^> & \
		exit /b 1 \
	)
	@echo üîº –ù–∞–∫–∞—Ç—ã–≤–∞–µ–º $(steps) –º–∏–≥—Ä–∞—Ü–∏–π...
	@$(MIGRATE) -path $(MIGRATIONS_PATH) -database "$(DB_URL)" up $(steps)

## –û—Ç–∫–∞—Ç–∏—Ç—å N –º–∏–≥—Ä–∞—Ü–∏–π
## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make migrate-down-steps steps=<–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ>
migrate-down-steps:
	@if not defined steps ( \
		echo ‚ùå –û—à–∏–±–∫–∞: —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤ & \
		echo    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make migrate-down-steps steps=^<—á–∏—Å–ª–æ^> & \
		exit /b 1 \
	)
	@echo üîΩ –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º $(steps) –º–∏–≥—Ä–∞—Ü–∏–π...
	@$(MIGRATE) -path $(MIGRATIONS_PATH) -database "$(DB_URL)" down $(steps)

## –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Å —à–∞–±–ª–æ–Ω–æ–º (–±–µ–∑ —Å–ª–æ–∂–Ω–æ–≥–æ bash)
migrate-create-idempotent:
	@if not defined name ( \
		echo ‚ùå –û—à–∏–±–∫–∞: —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ & \
		echo    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make migrate-create-idempotent name=^<–Ω–∞–∑–≤–∞–Ω–∏–µ^> & \
		exit /b 1 \
	)
	@echo üîß –°–æ–∑–¥–∞–Ω–∏–µ idemp–æ—Ç–µ–Ω—Ç–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏: $(name)
	@$(MIGRATE) create -ext sql -dir $(MIGRATIONS_PATH) -seq $(name)
	@echo üìù –®–∞–±–ª–æ–Ω —Å–æ–∑–¥–∞–Ω. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ SQL —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ $(MIGRATIONS_PATH)

## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–æ–º–∞–Ω–¥–∞–º –º–∏–≥—Ä–∞—Ü–∏–π
migrate-help:
	@echo üìñ –ö–û–ú–ê–ù–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° –ú–ò–ì–†–ê–¶–ò–Ø–ú–ò
	@echo.
	@echo üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
	@echo   make migrate-create name=^<–Ω–∞–∑–≤–∞–Ω–∏–µ^>    - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
	@echo   make migrate-up                        - –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
	@echo   make migrate-down                      - –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
	@echo   make migrate-force version=^<–Ω–æ–º–µ—Ä^>     - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é
	@echo   make migrate-version                   - –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
	@echo.
	@echo üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:
	@echo   make migrate-test                      - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (up->down->up)
	@echo   make migrate-check                     - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
	@echo.
	@echo üõ†Ô∏è  –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
	@echo   make migrate-down-all                  - –û—Ç–∫–∞—Ç–∏—Ç—å –í–°–ï –º–∏–≥—Ä–∞—Ü–∏–∏
	@echo   make migrate-up-steps steps=^<N^>        - –ü—Ä–∏–º–µ–Ω–∏—Ç—å N –º–∏–≥—Ä–∞—Ü–∏–π
	@echo   make migrate-down-steps steps=^<N^>      - –û—Ç–∫–∞—Ç–∏—Ç—å N –º–∏–≥—Ä–∞—Ü–∏–π
	@echo   make migrate-create-idempotent name=^<n^>- –°–æ–∑–¥–∞—Ç—å idemp–æ—Ç–µ–Ω—Ç–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é
	@echo.
	@echo üìã –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
	@echo   make migrate-create name=add_users_table
	@echo   make migrate-up
	@echo   make migrate-down
	@echo   make migrate-force version=1
	@echo   make migrate-test

# ============================================================================
# –ö–û–ú–ê–ù–î–ê –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
# ============================================================================
.DEFAULT_GOAL := migrate-help